# eMMC最適化 評価チェックリスト

---

## 評価の全体構成

| フェーズ | 内容 | 必須/推奨 |
|---------|------|---------|
| 1. 事前計測 | ベースライン取得 | 必須 |
| 2. コード最適化評価 | mringf_info書き込み頻度削減の効果測定 | 必須 |
| 3. カーネルパラメータ評価 | 各パラメータの変更前後比較 | 推奨 |
| 4. 総合評価 | 組み合わせ効果の確認 | 必須 |
| 5. 長期モニタリング | 継続的な健全性確認 | 必須 |

---

## フェーズ1: 事前計測（ベースライン）

### 1-1. カーネルパラメータ 現在値の記録

```bash
sudo sysctl vm.dirty_writeback_centisecs
sudo sysctl vm.dirty_expire_centisecs
sudo sysctl vm.dirty_background_ratio
sudo sysctl vm.dirty_ratio
```

| パラメータ | デフォルト値 | 計測日時 | 実測値 |
|-----------|------------|---------|-------|
| vm.dirty_writeback_centisecs | 500 (5秒) | | |
| vm.dirty_expire_centisecs | 3000 (30秒) | | |
| vm.dirty_background_ratio | 10% | | |
| vm.dirty_ratio | 20% | | |

- [ ] 現在値を記録した

### 1-2. eMMC書き込みレート ベースライン計測

```bash
# 10分間の書き込み量を計測
iostat -x 10 60 /dev/mmcblk0 | tee baseline_before.log

# または emmc_write_check.sh を使用
sudo ./emmc_write_check.sh
```

| 項目 | 計測日時 | 実測値 |
|-----|---------|-------|
| 書き込みレート (MB/秒) | | |
| 書き込み量 (GB/日) | | |
| 推定eMMC寿命 | | |

- [ ] ベースライン書き込みレートを記録した

### 1-3. emmc_test ベースライン（修正前動作）

```bash
cd emmc_test
sudo ./emmc_test 0 60 100   # モード0 (修正前) 60秒
```

| 項目 | 期待値 | 実測値 |
|-----|-------|-------|
| Total write amount (MB) | 約2,500 MB | |
| INFO書き込み回数 | 約9,000回 | |

- [ ] モード0 (修正前) の書き込み量を記録した

---

## フェーズ2: コード最適化の評価

### 2-1. emmc_test による効果測定

```bash
# クリーンアップしてからモード1で計測
sudo rm -rf /opt/emmc_test/data/*
sudo ./emmc_test 1 60 100   # モード1 (修正後) 60秒
```

| 項目 | 期待値 | 実測値 | 判定 |
|-----|-------|-------|-----|
| Total write amount (MB) | 約85 MB | | |
| INFO書き込み回数 | 2回 | | |
| 削減率 | 約96% | | |

- [ ] モード1 (修正後) の書き込み量を記録した
- [ ] 削減率が90%以上であることを確認した

### 2-2. 削減率の計算

```
削減率 = (修正前 - 修正後) / 修正前 × 100
       = (_____ MB - _____ MB) / _____ MB × 100
       = _____%
```

判定基準：
- ✅ 合格: 削減率 90% 以上
- ⚠️ 要確認: 削減率 80〜90%
- ❌ 不合格: 削減率 80% 未満

判定結果: [ ] ✅ 合格 / [ ] ⚠️ 要確認 / [ ] ❌ 不合格

---

## フェーズ3: カーネルパラメータの評価

### 3-1. 評価対象パラメータ一覧

#### vm.dirty_writeback_centisecs

カーネルのpdflushデーモンがダーティページをチェックする間隔。

| プロファイル | 設定値 | 相当秒数 | 変更前 | 変更後 |
|-----------|-------|---------|------|------|
| デフォルト | 500 | 5秒 | | |
| 安全重視型 | 700 | 7秒 | | |
| バランス型（推奨） | 1000 | 10秒 | | |
| 最大延命型 | 3000 | 30秒 | | |

- [ ] 選択したプロファイルを記録した: ________

#### vm.dirty_expire_centisecs

ダーティページが次回チェック時に必ず書き込まれるまでの経過時間。

| プロファイル | 設定値 | 相当秒数 | 変更前 | 変更後 |
|-----------|-------|---------|------|------|
| デフォルト | 3000 | 30秒 | | |
| 安全重視型 | 4500 | 45秒 | | |
| バランス型（推奨） | 6000 | 60秒 | | |
| 最大延命型 | 12000 | 120秒 | | |

- [ ] 選択したプロファイルを記録した: ________

#### vm.dirty_background_ratio

バックグラウンド書き込みを開始するメモリ占有率の閾値。

| プロファイル | 設定値 | 変更前 | 変更後 |
|-----------|-------|------|------|
| デフォルト / 安全重視型 | 10% | | |
| バランス型（推奨） | 15% | | |
| 最大延命型 | 20% | | |

- [ ] 選択したプロファイルを記録した: ________

#### vm.dirty_ratio

強制同期書き込みを開始するメモリ占有率の閾値。

| プロファイル | 設定値 | 変更前 | 変更後 |
|-----------|-------|------|------|
| デフォルト / 安全重視型 | 20% | | |
| バランス型（推奨） | 30% | | |
| 最大延命型 | 40% | | |

- [ ] 選択したプロファイルを記録した: ________

### 3-2. パラメータ適用手順

```bash
cd scripts
sudo ./apply_emmc_optimization.sh
```

- [ ] プロファイルを選択して適用した
- [ ] 一時適用後、設定値を `sysctl` で確認した
- [ ] 恒久設定ファイル `/etc/sysctl.d/99-emmc-optimize.conf` を作成した（再起動後も有効にする場合）

### 3-3. パラメータ変更後の書き込みレート計測

```bash
# 適用後10分間の書き込み量を計測
iostat -x 10 60 /dev/mmcblk0 | tee baseline_after_kernel.log
```

| 項目 | 変更前 | 変更後 | 削減率 |
|-----|-------|-------|------|
| 書き込みレート (MB/秒) | | | |
| 書き込み量 (GB/日) | | | |
| 推定eMMC寿命 | | | |

判定基準（バランス型の場合）：
- ✅ 合格: 削減率 25% 以上
- ⚠️ 要確認: 削減率 10〜25%
- ❌ 不合格: 削減率 10% 未満

判定結果: [ ] ✅ 合格 / [ ] ⚠️ 要確認 / [ ] ❌ 不合格

### 3-4. データ欠損リスクの確認

| プロファイル | 停電時最大データ欠損 | UPS有無 | リスク評価 |
|-----------|----------------|--------|---------|
| 安全重視型 | 最大45秒 | 不要（推奨） | 低 |
| バランス型（推奨） | 最大60秒 | 推奨 | 中 |
| 最大延命型 | 最大120秒 | 必須 | 高 |

- [ ] 適用したプロファイルのデータ欠損リスクを把握した
- [ ] UPS導入状況を確認した: [ ] 有 / [ ] 無
- [ ] リスクが許容範囲内であることを確認した

---

## フェーズ4: 総合評価

### 4-1. コード最適化 + カーネルパラメータ 組み合わせ効果

| 対策 | 書き込み量削減 | 推定eMMC寿命 | 実測値 | 判定 |
|-----|-------------|-----------|------|-----|
| 最適化なし（修正前） | 基準 | 約6ヶ月 | | |
| コード最適化のみ | 約96% | 約5年 | | |
| コード最適化 + 安全重視型 | 約96〜97% | 約5〜6年 | | |
| コード最適化 + バランス型 | 約97〜98% | 約7年 | | |
| コード最適化 + 最大延命型 | 約98% | 約10年 | | |

### 4-2. eMMCヘルスチェック スクリプト実行

```bash
sudo ./scripts/emmc_health_check.sh
```

| 項目 | 確認内容 | 結果 |
|-----|---------|-----|
| 累積書き込み量 (GB) | 現在の消耗量 | |
| 書き込みレート (GB/日) | 最適化後の日次書き込み | |
| 推定残り寿命 | 目標: 5年以上 | |
| カーネルパラメータ | 意図した値が反映されているか | |

- [ ] ヘルスチェックの出力に異常がないことを確認した
- [ ] 推定寿命が目標値（5年以上）を満たしていることを確認した

### 4-3. システム動作への影響確認

1週間の動作確認期間中に以下を確認する。

| 確認項目 | 確認方法 | 結果 |
|---------|---------|-----|
| アプリケーション正常動作 | ログ確認・目視 | |
| データ整合性 | ファイル内容の確認 | |
| 書き込みレート継続測定 | emmc_health_check.sh | |
| パラメータ設定の維持 | sysctl コマンドで確認 | |
| メモリ使用量への影響 | free / vmstat で確認 | |

- [ ] 1週間の動作確認を完了した
- [ ] 異常なし

---

## フェーズ5: 長期モニタリング

### 5-1. 定期実行設定

```bash
# cron に登録（毎日3時に実行）
sudo crontab -e
# 以下を追加：
0 3 * * * /path/to/emmc_check/scripts/emmc_health_check.sh
```

- [ ] cron に登録した

### 5-2. 月次確認項目

| 月次確認 | 確認内容 | 基準 |
|---------|---------|-----|
| 書き込みレート | 増加傾向がないか | 最適化後レートの ±20% 以内 |
| 推定寿命 | 目標値を維持しているか | 5年以上 |
| カーネルパラメータ | 再起動後も保持されているか | 設定値と一致 |
| ログの異常 | WARNING / CRITICAL が出ていないか | なし |

### 5-3. アラート基準

| アラートレベル | 条件 | 対応 |
|-------------|-----|-----|
| WARNING | 書き込み > 1TB/日 | 原因調査 |
| CAUTION | 書き込み > 500GB/日 | 監視強化 |
| CRITICAL | 推定残り寿命 < 1年 | 機器交換計画 |

- [ ] アラート通知の仕組みを確認した（ログ監視・メール通知等）

### 5-4. 6ヶ月後の効果検証

| 検証項目 | ベースライン値 | 6ヶ月後実測値 | 評価 |
|---------|-------------|------------|-----|
| 書き込みレート (GB/日) | | | |
| 推定eMMC寿命 | | | |
| 累積書き込み量 (GB) | | | |

---

## 評価サマリー

| フェーズ | 担当者 | 実施日 | 判定 | 備考 |
|---------|-------|-------|-----|-----|
| 1. 事前計測 | | | [ ] 完了 | |
| 2. コード最適化評価 | | | [ ] 合格 / [ ] 不合格 | |
| 3. カーネルパラメータ評価 | | | [ ] 合格 / [ ] 不合格 | |
| 4. 総合評価 | | | [ ] 合格 / [ ] 不合格 | |
| 5. 長期モニタリング設定 | | | [ ] 完了 | |

### 採用プロファイル

- コード最適化: [ ] 適用済み
- カーネルプロファイル: [ ] 安全重視型 / [ ] バランス型 / [ ] 最大延命型 / [ ] 未適用

### 最終判定

- [ ] ✅ 全フェーズ合格 — 本番環境への適用を推奨
- [ ] ⚠️ 条件付き合格 — 備考欄の条件を満たした上で適用
- [ ] ❌ 不合格 — 再評価が必要
